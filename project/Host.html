<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rent Out Dashboard</title>
   <link rel="stylesheet" href="Host.css">
</head>
<body>
  <div class="loader-container">
    <div class="loader"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <nav>
    <div class="logo">
      <img title="Home" onclick="window.open('index.html')" src="https://img.freepik.com/premium-psd/modern-house-transparency-background-psd_693425-20565.jpg" alt="Logo" />
      House Rental
    </div>

    <div class="nav-links" id="navLinks">
      </div>

    <div class="hamburger" id="hamburger">
      <div></div>
      <div></div>
      <div></div>
    </div>
  </nav>

  <div class="side-nav" id="sideNav">
    </div>

  <div class="main-content">
    <button class="add-rentout-btn" id="openFormBtn">+ Add Rent Out</button>

    <div class="modal-overlay" id="modalOverlay">
      <div class="form-section">
        <button class="close-btn" id="closeFormBtn">âœ–</button>
        <h2 id="heading">ðŸ“‹ Add Rent Out</h2>
        <div class="form-grid">
          <input type="text" id="house-name" class="fancy-input" placeholder="House Name">
          <input type="text" id="location" class="fancy-input" placeholder="Location">
          <input type="number" id="price" class="fancy-input" placeholder="Price">
          <input type="text" id="contact" class="fancy-input" placeholder="Contact Number">
          <input type="number" id="beds" class="fancy-input" placeholder="No. of Beds" min="1">

          <div class="file-input-container">
            <label for="image-file" class="file-input-label" id="fileLabel">
              <div class="file-input-text">ðŸ“· Upload House Image</div>
              <div class="file-input-hint">Click to select a photo of your house/property</div>
            </label>
            <input type="file" id="image-file" class="file-input-hidden" accept="image/*">
            <img id="imagePreview" class="file-preview" style="display: none;">
          </div>

          <button class="submit-btn" onclick="updateRentout()">Submit</button>
        </div>
      </div>
    </div>

    <div id="cards-container"></div>
  </div>

  <script>
    const baseUrl = "https://home-rental-b3lp.onrender.com/clients";
    let userId = "";
    let editIndex = null;
    let currentUser = null; // To store the fetched client data

    // --- Cookie Management Functions ---
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for(let i=0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function setCookie(name, value, days) {
      let expires = "";
      if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function eraseCookie(name) {
      document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    }
    // --- End Cookie Management Functions ---


    function checkLoginStatus() {
      userId = getCookie("userId"); // Get userId from cookie
      if (!userId) {
        // Only redirect if we are on the dashboard page and not logged in
        if (window.location.pathname.endsWith('host_dashboard.html') || window.location.pathname.endsWith('host_dashboard')) {
          alert("Session expired. Please login again.");
          window.location.href = "host_login.html";
        }
      }
    }

    // Update navigation based on login status
async function updateNavigation() {
  const navLinks = document.getElementById('navLinks');
  const sideNav = document.getElementById('sideNav');
  const currentUserId = getCookie("userId");

  // Always include static links first
  const staticNavLinksHtml = `
      <a href="index.html">Home</a>
      <a href="properties.html">Properties</a>
      <a href="about.html">About</a>
  `;

  navLinks.innerHTML = staticNavLinksHtml;
  sideNav.innerHTML = staticNavLinksHtml;

  if (currentUserId) {
    // User is logged in
    const client = await fetchClientData();
    if (client) {
      currentUser = client;
      const userName = client.name || client.email || 'User';

      // Create simple greeting for desktop nav (no dropdown, no logout button)
      const userGreetingHtml = `
        <span style="color: #38bdf8; font-weight: 600;">Hello! ${userName.length > 12 ? userName.substring(0, 12) + '...' : userName}</span>
      `;
      navLinks.insertAdjacentHTML('beforeend', userGreetingHtml);

      // Append to mobile nav (simple greeting, no logout)
      const mobileGreetingHtml = `
        <a href="#" style="color: #38bdf8;">Hello! ${userName}</a>
      `;
      sideNav.insertAdjacentHTML('beforeend', mobileGreetingHtml);

    } else {
      // If client data not found, clear cookie and show login/signup
      eraseCookie("userId");
      navLinks.insertAdjacentHTML('beforeend', `
        <button onclick="window.open('host_signup.html')">Sign Up</button>
        <button onclick="window.open('host_login.html')">Login</button>
      `);
      sideNav.insertAdjacentHTML('beforeend', `
        <a href="#" onclick="window.open('host_signup.html')">Sign Up</a>
        <a href="#" onclick="window.open('host_login.html')">Login</a>
      `);
    }
  } else {
    // User is not logged in - show both buttons
    navLinks.insertAdjacentHTML('beforeend', `
      <button onclick="window.open('host_signup.html')">Sign Up</button>
      <button onclick="window.open('host_login.html')">Login</button>
    `);
    sideNav.insertAdjacentHTML('beforeend', `
      <a href="#" onclick="window.open('host_signup.html')">Sign Up</a>
      <a href="#" onclick="window.open('host_login.html')">Login</a>
    `);
  }
}

    // Enhanced function to check login before opening form
    function checkLoginAndOpenForm() {
      const currentUserId = getCookie("userId");

      if (!currentUserId) {
        // Show login prompt and redirect
        if (confirm("Please login to add rent out properties. Click OK to go to login page.")) {
          window.location.href = "host_login.html";
        }
        return false;
      }

      // User is logged in, open the form
      const modalOverlay = document.getElementById('modalOverlay');
      modalOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      clearForm(); // Reset form when opening
      return true;
    }

    // Refresh session cookie to last 7 days
    function extendSession() {
      const uid = getCookie("userId");
      if (uid) {
        setCookie("userId", uid, 7); // Extend cookie by 7 days
      }
    }

    async function fetchClientData() {
      userId = getCookie("userId"); // Ensure userId is updated from cookie
      if (!userId) {
        console.warn("No userId found in cookie.");
        return null;
      }

      try {
        const res = await fetch(`${baseUrl}/${userId}`); // Fetch by ID directly
        if (!res.ok) {
            if (res.status === 404) {
                console.warn(`Client with ID ${userId} not found.`);
                eraseCookie("userId"); // Clear invalid cookie
                checkLoginStatus(); // Re-check login, will redirect
            }
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        return data;
      } catch (error) {
        console.error("Error fetching client data:", error);
        return null;
      }
    }

    async function displayRentout() {
      const client = await fetchClientData();
      const container = document.getElementById("cards-container");

      if (!client || !Array.isArray(client.rentouts) || client.rentouts.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 50px; color: rgba(255,255,255,0.7);">
            <h3 style='color:white;'>No rentout properties yet</h3>
            <p style='color:white'>Click the "+ Add Rent Out" button to add your first property!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = "";
      client.rentouts.forEach((rentout, index) => {
        const card = document.createElement("div");
        card.className = "preview";
        card.innerHTML = `
          <img src="${rentout.imageUrl}" alt="House Image"/>
          <div class="preview-content">
            <h3>${rentout.houseName}</h3>
            <p><strong>Location:</strong> ${rentout.location}</p>
            <p><strong>Price:</strong> â‚¹${rentout.price}</p>
            <p><strong>Contact:</strong> ${rentout.contact}</p>
            <p><strong>Beds:</strong> ${rentout.beds}</p>
          </div>
          <div class="actions">
            <button title='Edit' onclick="editRentout(${index})">Edit</button>
            <button title='Delete' onclick="deleteRentout(${index})">Delete</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    async function updateRentout() {
      const houseName = document.getElementById("house-name").value.trim();
      const location = document.getElementById("location").value.trim();
      const price = document.getElementById("price").value.trim();
      const contact = document.getElementById("contact").value.trim();
      const beds = document.getElementById("beds").value.trim();
      const imageInput = document.getElementById("image-file");

      if (!houseName || !location || !price || !contact || !beds || parseInt(beds) < 1) {
        alert("Please fill all fields correctly (beds â‰¥ 1).");
        return;
      }

      const client = await fetchClientData();
      if (!client) return;

      if (!Array.isArray(client.rentouts)) client.rentouts = [];

      const handleSave = async (imageUrl = null) => {
        const rentout = {
          houseName, location, price, contact, beds,
          imageUrl: imageUrl || (editIndex !== null && client.rentouts[editIndex] ? client.rentouts[editIndex].imageUrl : "")
        };

        if (editIndex !== null) {
          client.rentouts[editIndex] = rentout;
          editIndex = null;
        } else {
          client.rentouts.push(rentout);
        }

        try {
            const res = await fetch(`${baseUrl}/${client.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(client)
            });
            if (!res.ok) throw new Error(`Failed to update client data: ${res.statusText}`);

            // Close modal after submission
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';

            clearForm();
            displayRentout(); // Re-display cards after update
        } catch (error) {
            console.error("Error saving rentout:", error);
            alert("Failed to save property. Please try again.");
        }
      };

      if (imageInput.files.length > 0) {
        const file = imageInput.files[0];
        // Basic image type validation (can be more robust)
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file (jpg, jpeg, png, gif).');
            return;
        }
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            alert('Image file is too large. Max 5MB allowed.');
            return;
        }

        const reader = new FileReader();
        reader.onloadend = () => handleSave(reader.result);
        reader.readAsDataURL(file);
      } else {
        // If no new image selected, use existing one if in edit mode
        handleSave();
      }
    }

    function clearForm() {
      document.getElementById("house-name").value = "";
      document.getElementById("location").value = "";
      document.getElementById("price").value = "";
      document.getElementById("contact").value = "";
      document.getElementById("beds").value = "";
      document.getElementById("image-file").value = "";
      document.querySelector(".submit-btn").textContent = "Submit";
      document.getElementById('heading').innerHTML = 'ðŸ“‹ Add Rent Out';

      // Reset file input display
      const fileLabel = document.getElementById('fileLabel');
      const imagePreview = document.getElementById('imagePreview');
      fileLabel.classList.remove('has-file');
      fileLabel.innerHTML = `
        <div class="file-input-text">ðŸ“· Upload House Image</div>
        <div class="file-input-hint">Click to select a photo of your house/property</div>
      `;
      imagePreview.style.display = 'none';
      imagePreview.src = '#'; // Clear src
    }

    // File input handling
    function setupFileInput() {
      const fileInput = document.getElementById('image-file');
      const fileLabel = document.getElementById('fileLabel');
      const imagePreview = document.getElementById('imagePreview');

      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Check if it's an image
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file for your house/property');
            fileInput.value = ''; // Clear the input
            imagePreview.style.display = 'none';
            fileLabel.classList.remove('has-file');
            fileLabel.innerHTML = `<div class="file-input-text">ðŸ“· Upload House Image</div><div class="file-input-hint">Click to select a photo of your house/property</div>`;
            return;
          }

          // Check file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB');
            fileInput.value = ''; // Clear the input
            imagePreview.style.display = 'none';
            fileLabel.classList.remove('has-file');
            fileLabel.innerHTML = `<div class="file-input-text">ðŸ“· Upload House Image</div><div class="file-input-hint">Click to select a photo of your house/property</div>`;
            return;
          }

          // Show file name and preview
          fileLabel.classList.add('has-file');
          fileLabel.innerHTML = `
            <div class="file-input-text">âœ… ${file.name}</div>
            <div class="file-input-hint">Click to change house image</div>
          `;

          // Show image preview
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
            // No file selected, reset label and preview
            imagePreview.style.display = 'none';
            imagePreview.src = '#';
            fileLabel.classList.remove('has-file');
            fileLabel.innerHTML = `<div class="file-input-text">ðŸ“· Upload House Image</div><div class="file-input-hint">Click to select a photo of your house/property</div>`;
        }
      });
    }

    async function editRentout(index) {
      const client = await fetchClientData();
      if (!client || !Array.isArray(client.rentouts)) return;

      const rentout = client.rentouts[index];
      if (!rentout) { // Add a check if rentout exists at index
          console.error("Rentout not found at index:", index);
          return;
      }

      document.getElementById("house-name").value = rentout.houseName;
      document.getElementById("location").value = rentout.location;
      document.getElementById("price").value = rentout.price;
      document.getElementById("contact").value = rentout.contact;
      document.getElementById("beds").value = rentout.beds;
      editIndex = index;
      document.getElementById('heading').innerHTML = 'ðŸ“‹ Edit Rent Out';
      document.querySelector(".submit-btn").textContent = "Update";

      // Open the modal for editing
      document.getElementById('modalOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';

      // Load image preview if it exists
      const imagePreview = document.getElementById('imagePreview');
      const fileLabel = document.getElementById('fileLabel');
      if (rentout.imageUrl) {
        imagePreview.src = rentout.imageUrl;
        imagePreview.style.display = 'block';
        fileLabel.classList.add('has-file');
        fileLabel.innerHTML = `
          <div class="file-input-text">âœ… Image Loaded</div>
          <div class="file-input-hint">Click to change house image</div>
        `;
      } else {
        imagePreview.style.display = 'none';
        imagePreview.src = '#';
        fileLabel.classList.remove('has-file');
        fileLabel.innerHTML = `
          <div class="file-input-text">ðŸ“· Upload House Image</div>
          <div class="file-input-hint">Click to select a photo of your house/property</div>
        `;
      }
    }

    async function deleteRentout(index) {
      if (!confirm("Are you sure you want to delete this property?")) return;

      const client = await fetchClientData();
      if (!client || !Array.isArray(client.rentouts)) return;

      // Check if the item exists at the index before splicing
      if (index > -1 && index < client.rentouts.length) {
          client.rentouts.splice(index, 1);
      } else {
          console.error("Invalid index for deletion:", index);
          return;
      }


      try {
        const res = await fetch(`${baseUrl}/${client.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(client)
        });
        if (!res.ok) throw new Error(`Failed to delete rentout: ${res.statusText}`);
        displayRentout(); // Re-display cards after deletion
      } catch (error) {
          console.error("Error deleting rentout:", error);
          alert("Failed to delete property. Please try again.");
      }
    }

    // function logout() {
    //   if (confirm("Are you sure you want to logout?")) {
    //     eraseCookie("userId"); // Remove the userId cookie
    //     window.location.href = "host_login.html"; // Redirect to login page after logout
    //   }
    // }

    // Modal functionality
    document.addEventListener('DOMContentLoaded', async function() {
      // Show loading animation for 1 second
      setTimeout(function() {
        document.querySelector('.loader-container').style.display = 'none';
      }, 1000);

      // Check login status first and redirect if not logged in
      checkLoginStatus();

      // Initialize navigation (after login check)
      await updateNavigation();

      // Setup file input functionality
      setupFileInput();

      // Modal controls
      const openFormBtn = document.getElementById('openFormBtn');
      const closeFormBtn = document.getElementById('closeFormBtn');
      const modalOverlay = document.getElementById('modalOverlay');

      openFormBtn.addEventListener('click', function() {
        checkLoginAndOpenForm(); // This function now handles the login check
      });

      closeFormBtn.addEventListener('click', function() {
        modalOverlay.classList.remove('active');
        document.body.style.overflow = 'auto';
        clearForm();
        editIndex = null;
      });

      // Close when clicking outside the form
      modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
          modalOverlay.classList.remove('active');
          document.body.style.overflow = 'auto';
          clearForm();
          editIndex = null;
        }
      });

      // Hamburger menu
      document.getElementById('hamburger').addEventListener('click', function () {
        document.getElementById('sideNav').classList.toggle('open');
        this.classList.toggle('active');
      });

      // Extend session and set interval for login status check
      extendSession(); // Extend cookie validity
      // This setInterval now primarily keeps the session alive, initial check handles redirection
      setInterval(checkLoginStatus, 60 * 60 * 1000); // Check every hour for session expiry

      // Initial display of rentouts (only if logged in)
      if (getCookie("userId")) {
          displayRentout();
      }
    });
  </script>
</body>
</html>
